#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# parse and derive params
BUILD_DIR=$HOME
CACHE_DIR=$HOME
AF_DEPLOY=0
TID=""

for i in "$@"
do
  case $i in
  --build-dir=*)
    BUILD_DIR=${i#*=}
    ;;
  --cache-dir=*)
    CACHE_DIR=${i#*=}
    ;;
  --tid=*)
    TID=${i#*=}
    ;;
  --deploy)
    AF_DEPLOY=1
    ;;
  esac
done

function print_info() {
  echo "-----> $*"
}

function indent() {
  sed -u 's/^/       /'
}

INSTALL_DIR=$BUILD_DIR/.appfirst

PKG_EXT=""
ARCH=""

if cat /proc/version 2> /dev/null | grep Ubuntu > /dev/null; then
    PKG_EXT="deb"
    ARCH=`uname -m`
elif cat /proc/version 2> /dev/null | grep Debian > /dev/null; then
    PKG_EXT="deb"
    ARCH=`uname -m`
elif cat /proc/version 2> /dev/null | grep Red > /dev/null; then
    PKG_EXT="rpm"
    ARCH=`uname -p`
fi

if [ $ARCH = "i686" ]; then
    ARCH="i386"
fi

if [ $ARCH = "i386" ]; then
    ARCH="32"
else
    ARCH="64"
fi

#PACKAGE="http://wwws.appfirst.com/packages/updates/distrodeb/distrodeb$ARCH.$PKG_EXT"
PACKAGE="https://www.dropbox.com/s/83oxhg14thgiwu7/distrodeb64.deb"

PACKAGE_NAME=$(basename $PACKAGE .$PKG_EXT)
PACKAGE_FILE=$INSTALL_DIR/$PACKAGE_NAME.$PKG_EXT

mkdir -p $INSTALL_DIR
mkdir -p $INSTALL_DIR/var
mkdir -p $INSTALL_DIR/opt/data

print_info "Downloading $PACKAGE"
curl -s -L -z $PACKAGE_FILE -o $PACKAGE_FILE $PACKAGE 2>&1 | indent

print_info "Extracting $PACKAGE_NAME.$PKG_EXT"

dpkg -x $PACKAGE_FILE $INSTALL_DIR

rm -rf $PACKAGE_FILE

if [ $AF_DEPLOY = 1 ]; then
    print_info "Configuring AppFirst package"
    sed -i "/Tenant/c\   Tenant $TID" $HOME/.appfirst/etc/AppFirst.conf
    cp $HOME/.appfirst/etc/AppFirst.conf $HOME/.appfirst/etc/AppFirst

    if [ ! -e $HOME/.appfirst/usr/share/appfirst/AppFirst ]; then
        ln -s $HOME/.appfirst/etc/AppFirst $HOME/.appfirst/usr/share/appfirst/AppFirst
    fi

    export LD_LIBRARY_PATH="$HOME/.appfirst/usr/share/appfirst:$LD_LIBRARY_PATH"
    export LD_PRELOAD="$HOME/.appfirst/usr/share/appfirst/libwrap.so.1.0.1"
    $HOME/.appfirst/usr/bin/collector --piddir="$HOME/.appfirst/var" --datadir="$HOME/.appfirst/opt/data"
else
    print_info "Building startup script"
    STARTUP_SCRIPT=$BUILD_DIR/startup.sh

    echo "#!/bin/bash" > $STARTUP_SCRIPT
    echo "sed -i \"/Tenant/c\   Tenant \$1\" \$HOME/.appfirst/etc/AppFirst.conf" >> $STARTUP_SCRIPT
    echo "cp \$HOME/.appfirst/etc/AppFirst.conf \$HOME/.appfirst/etc/AppFirst" >> $STARTUP_SCRIPT
    echo "if [ ! -e \$HOME/.appfirst/usr/share/appfirst/AppFirst ]; then" >> $STARTUP_SCRIPT
    echo "ln -s \$HOME/.appfirst/etc/AppFirst \$HOME/.appfirst/usr/share/appfirst/AppFirst" >> $STARTUP_SCRIPT
    echo "fi"  >> $STARTUP_SCRIPT
    echo "\$HOME/.appfirst/usr/bin/collector --piddir=\"\$HOME/.appfirst/var\" --datadir=\"\$HOME/.appfirst/opt/data\" -d 1 2> /dev/null" >> $STARTUP_SCRIPT
    chmod 0777 $STARTUP_SCRIPT
fi

print_info "Building runtime environment"

mkdir -p $BUILD_DIR/.profile.d
PROFILE_D_SCRIPT=$BUILD_DIR/.profile.d/appfirst.sh
echo "#!/bin/bash" > $PROFILE_D_SCRIPT
echo "export LD_LIBRARY_PATH=\"\$HOME/.appfirst/usr/share/appfirst:\$LD_LIBRARY_PATH\"" >> $PROFILE_D_SCRIPT
echo "export LD_PRELOAD=\"\$HOME/.appfirst/usr/share/appfirst/libwrap.so.1.0.1\"" >> $PROFILE_D_SCRIPT
echo "if [ ! -e \$HOME/.appfirst/usr/share/appfirst/AppFirst ]; then" >> $PROFILE_D_SCRIPT
echo "ln -s \$HOME/.appfirst/etc/AppFirst \$HOME/.appfirst/usr/share/appfirst/AppFirst" >> $PROFILE_D_SCRIPT
echo "fi"  >> $PROFILE_D_SCRIPT

cat $PROFILE_D_SCRIPT

if [ $AF_DEPLOY = 1 ]; then
    echo "\$HOME/.appfirst/usr/bin/collector --piddir=\"\$HOME/.appfirst/var\" --datadir=\"\$HOME/.appfirst/opt/data\"" >> $PROFILE_D_SCRIPT
fi

chmod 0777 $PROFILE_D_SCRIPT

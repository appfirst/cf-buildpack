#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

function print_info() {
  echo "-----> $*"
}

function indent() {
  sed -u 's/^/       /'
}

STARTUP_SCRIPT=$BUILD_DIR/startup.sh
INSTALL_DIR=$BUILD_DIR/.appfirst

PKG_EXT=""
ARCH=""

if cat /proc/version 2> /dev/null | grep Ubuntu > /dev/null; then
    PKG_EXT="deb"
    ARCH=`uname -m`
elif cat /proc/version 2> /dev/null | grep Debian > /dev/null; then
    PKG_EXT="deb"
    ARCH=`uname -m`
elif cat /proc/version 2> /dev/null | grep Red > /dev/null; then
    PKG_EXT="rpm"
    ARCH=`uname -p`
fi

if [ $ARCH = "i686" ]; then
    ARCH="i386"
fi

#PACKAGE="http://wwws.appfirst.com/packages/initial/1/appfirst-$ARCH.$PKG_EXT"
PACKAGE="https://www.dropbox.com/s/83oxhg14thgiwu7/distrodeb64.deb"

PACKAGE_NAME=$(basename $PACKAGE .$PKG_EXT)
PACKAGE_FILE=$INSTALL_DIR/$PACKAGE_NAME.$PKG_EXT

mkdir -p $INSTALL_DIR
mkdir -p $INSTALL_DIR/var
mkdir -p $INSTALL_DIR/opt/data

print_info "Downloading $PACKAGE"
curl -s -L -z $PACKAGE_FILE -o $PACKAGE_FILE $PACKAGE 2>&1 | indent

print_info "Extracting $PACKAGE_NAME.$PKG_EXT"
dpkg -x $PACKAGE_FILE $INSTALL_DIR
rm -rf $PACKAGE_FILE

print_info "Building startup script"

echo "#!/bin/bash" > $STARTUP_SCRIPT
echo "sed -i \"/Tenant/c\   Tenant \$1\" \$HOME/.appfirst/etc/AppFirst.conf" >> $STARTUP_SCRIPT
echo "cp \$HOME/.appfirst/etc/AppFirst.conf \$HOME/.appfirst/etc/AppFirst" >> $STARTUP_SCRIPT
echo "\$HOME/.appfirst/usr/bin/collector --piddir=\"\$HOME/.appfirst/var\" --datadir=\"\$HOME/.appfirst/opt/data\" -d 1 2> /dev/null" >> $STARTUP_SCRIPT
chmod 0777 $STARTUP_SCRIPT

print_info "Building runtime environment"

mkdir -p $BUILD_DIR/.profile.d
PROFILE_D_SCRIPT=$BUILD_DIR/.profile.d/appfirst.sh
echo "export LD_LIBRARY_PATH=\"\$HOME/.appfirst/usr/share/appfirst:\$LD_LIBRARY_PATH\"" > $PROFILE_D_SCRIPT
echo "export LD_PRELOAD=\"\$HOME/.appfirst/usr/share/appfirst/libwrap.so.1.0.1\"" >> $PROFILE_D_SCRIPT
